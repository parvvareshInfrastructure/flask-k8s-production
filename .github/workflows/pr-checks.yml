name: PR Checks

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  validate-k8s:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up kubectl
      uses: azure/setup-kubectl@v4
      with:
        version: 'latest'

    - name: Validate Kubernetes manifests
      run: |
        for file in k8s/*.yaml; do
          echo "Validating $file"
          kubectl apply --dry-run=client -f "$file"
        done

    - name: Install kubeval
      run: |
        wget https://github.com/instrumenta/kubeval/releases/latest/download/kubeval-linux-amd64.tar.gz
        tar xf kubeval-linux-amd64.tar.gz
        sudo mv kubeval /usr/local/bin

    - name: Run kubeval
      run: |
        for file in k8s/*.yaml; do
          echo "Validating $file with kubeval"
          kubeval "$file"
        done

  dockerfile-lint:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Run Hadolint
      uses: hadolint/hadolint-action@v3.1.0
      with:
        dockerfile: Dockerfile
        failure-threshold: warning

  check-dependencies:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Check for security vulnerabilities
      run: |
        pip install safety
        safety check -r app/requirements.txt --json
      continue-on-error: true

    - name: Check for outdated dependencies
      run: |
        pip install pip-audit
        pip-audit -r app/requirements.txt
      continue-on-error: true
